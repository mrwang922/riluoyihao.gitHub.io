<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> ConcurrentHashMap1.8 | wdl&#39;s blog</title>
  <link rel = 'canonical' href = 'https://riluoyihao.github.io/post/concurrenthashmap1.8/'>
  <meta name="description" content="Java学习笔记">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="ConcurrentHashMap1.8" />
<meta property="og:description" content="ConcurrentHashMap 1.8 1. 前言 跟1.7比较的话，变化还是很大的。取消了分段锁。
1.1 concurrentHashMap是如何保证并发安全的？ 主要是利用Unsafe操作 &#43; synchronized关键字的。 Unsafe操作和1.7的类似，主要负责并发安全得修改对象的属性和数组中某个位置的值。 synchronized主要负责在需要操作某个位置时加锁（该位置不能为空），比如向某个位置的链表的头结点加锁，或者是给某个位置的树（TreeBin）加锁。 1.8 中仍然有分段锁的思想，只是1.7中段数是可控的。而1.8中是数组的每个位置都会加锁。
2. 初始化方法 默认初始化方法非常简单，就是一个空参构造器。
1public ConcurrentHashMap() { 2} 3.put方法 1public V put(K key, V value) { 2 return putVal(key, value, false); 3} 4 5final V putVal(K key, V value, boolean onlyIfAbsent) { 6 if (key == null || value == null) throw new NullPointerException(); 7 // 还是获取hash值。 8 int hash = spread(key.hashCode()); 9 int binCount = 0; 10 for (Node&lt;K,V&gt;[] tab = table;;) { 11 Node&lt;K,V&gt; f; int n, i, fh; 12 if (tab == null || (n = tab." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://riluoyihao.github.io/post/concurrenthashmap1.8/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-08-05T14:52:10&#43;08:00" />
<meta property="article:modified_time" content="2021-08-05T14:52:10&#43;08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ConcurrentHashMap1.8"/>
<meta name="twitter:description" content="ConcurrentHashMap 1.8 1. 前言 跟1.7比较的话，变化还是很大的。取消了分段锁。
1.1 concurrentHashMap是如何保证并发安全的？ 主要是利用Unsafe操作 &#43; synchronized关键字的。 Unsafe操作和1.7的类似，主要负责并发安全得修改对象的属性和数组中某个位置的值。 synchronized主要负责在需要操作某个位置时加锁（该位置不能为空），比如向某个位置的链表的头结点加锁，或者是给某个位置的树（TreeBin）加锁。 1.8 中仍然有分段锁的思想，只是1.7中段数是可控的。而1.8中是数组的每个位置都会加锁。
2. 初始化方法 默认初始化方法非常简单，就是一个空参构造器。
1public ConcurrentHashMap() { 2} 3.put方法 1public V put(K key, V value) { 2 return putVal(key, value, false); 3} 4 5final V putVal(K key, V value, boolean onlyIfAbsent) { 6 if (key == null || value == null) throw new NullPointerException(); 7 // 还是获取hash值。 8 int hash = spread(key.hashCode()); 9 int binCount = 0; 10 for (Node&lt;K,V&gt;[] tab = table;;) { 11 Node&lt;K,V&gt; f; int n, i, fh; 12 if (tab == null || (n = tab."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://riluoyihao.github.io/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css" integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://riluoyihao.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://riluoyihao.github.io/">
  
    <div id="logo" style="background-image: url(https://riluoyihao.github.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>wdl&#39;s blog</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/posts">Writings</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h1 id="concurrenthashmap-18">ConcurrentHashMap 1.8</h1>
<h3 id="1-前言">1. 前言</h3>
<p>跟1.7比较的话，变化还是很大的。取消了分段锁。</p>
<h4 id="11-concurrenthashmap是如何保证并发安全的">1.1 concurrentHashMap是如何保证并发安全的？</h4>
<p>主要是利用Unsafe操作 + synchronized关键字的。
Unsafe操作和1.7的类似，主要负责并发安全得修改对象的属性和数组中某个位置的值。
synchronized主要负责在需要操作某个位置时加锁（该位置不能为空），比如向某个位置的链表的头结点加锁，或者是给某个位置的树（TreeBin）加锁。
1.8 中仍然有分段锁的思想，只是1.7中段数是可控的。而1.8中是数组的每个位置都会加锁。</p>
<h3 id="2-初始化方法">2. 初始化方法</h3>
<p>默认初始化方法非常简单，就是一个空参构造器。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">ConcurrentHashMap</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="3put方法">3.put方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">public</span> V <span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> putVal<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#8be9fd;font-style:italic">final</span> V <span style="color:#50fa7b">putVal</span><span style="color:#ff79c6">(</span>K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> onlyIfAbsent<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> value <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> NullPointerException<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#6272a4">// 还是获取hash值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> spread<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#8be9fd">int</span> binCount <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">;;)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> f<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> n<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> fh<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>tab <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            <span style="color:#6272a4">// 初始化，查看 3.2 initTable。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>            tab <span style="color:#ff79c6">=</span> initTable<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#6272a4">// 获取table数组第i位的值。查看 3.3 tabAt
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>f <span style="color:#ff79c6">=</span> tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span> hash<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            <span style="color:#6272a4">// 查看 3.4 casTabAt
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 加入成功就break，否则就再循环一遍（for (Node&lt;K,V&gt;[] tab = table;;)），这次就会走其他逻辑了。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>casTabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>                         <span style="color:#ff79c6">new</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>                   <span style="color:#6272a4">// no lock when adding to empty bin
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>        <span style="color:#6272a4">// 这个值为查看ForwardingNode，说明正在扩容。就去帮助扩容。查看3.11 helpTransfer。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>fh <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> MOVED<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>            tab <span style="color:#ff79c6">=</span> helpTransfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> f<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>            V oldVal <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            <span style="color:#6272a4">// 这里加锁，保证了并发安全性。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>                <span style="color:#6272a4">// 再判断一次，目的是检查下头结点是否发生了变化，如果发生了变化说明在加锁的过程中有其他线程修改了该链表的头结点，就直接再循环一遍（for (Node&lt;K,V&gt;[] tab = table;;)）。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>                    <span style="color:#6272a4">// hash值为正数时表明为链表结构，遍历链表插入或覆盖。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#6272a4"></span>                    <span style="color:#6272a4">// 为什么hash值为正数时是链表呢？查看3.1 TreeBin。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>fh <span style="color:#ff79c6">&gt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>                        binCount <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>                        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">;;</span> <span style="color:#ff79c6">++</span>binCount<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                            K ek<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>                                <span style="color:#ff79c6">((</span>ek <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                                 <span style="color:#ff79c6">(</span>ek <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>ek<span style="color:#ff79c6">))))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                                oldVal <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>onlyIfAbsent<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>                                    e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>                                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>                            Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> pred <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>                                pred<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>                                                          value<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>                                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>                    <span style="color:#6272a4">// hash值为负数时，再判断是否为红黑树。查看3.1 TreeBin
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>f <span style="color:#ff79c6">instanceof</span> TreeBin<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>                        Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>                        binCount <span style="color:#ff79c6">=</span> 2<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>                        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>p <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">((</span>TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;)</span>f<span style="color:#ff79c6">).</span><span style="color:#50fa7b">putTreeVal</span><span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>                                                       value<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>                            oldVal <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>onlyIfAbsent<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>                                p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>            <span style="color:#6272a4">// 最后是判断数量，检查是否需要树化。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>binCount <span style="color:#ff79c6">!=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>binCount <span style="color:#ff79c6">&gt;=</span> TREEIFY_THRESHOLD<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>                    treeifyBin<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>oldVal <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>                    <span style="color:#ff79c6">return</span> oldVal<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>    <span style="color:#6272a4">// 数量加1，这里也非常绕，查看3.5 addCount
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span><span style="color:#6272a4"></span>    addCount<span style="color:#ff79c6">(</span>1L<span style="color:#ff79c6">,</span> binCount<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="31-treebin">3.1 TreeBin</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>TreeBin<span style="color:#ff79c6">(</span>TreeNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> b<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>TREEBIN<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">first</span> <span style="color:#ff79c6">=</span> b<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> TREEBIN   <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>2<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// hash for roots of trees
</span></code></pre></div><p>需要说明的就是这里，不同于hashMap，concurrentHashMap里table数组保存红黑树的位置存放的是TreeBin，可以看作是一棵树的根节点。其实该节点无意义。该根节点的hash值是一个固定值-2，目的就是根据hash值快速区分链表和红黑树。真正的根节点是first。</p>
<h4 id="32-inittable">3.2 initTable</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> <span style="color:#50fa7b">initTable</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> sc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">((</span>tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#6272a4">// sizeCtl 最开始为0 查看 3.2.1 sizeCtl
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>sc <span style="color:#ff79c6">=</span> sizeCtl<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            <span style="color:#6272a4">// 当有线程正在初始化table且还未初始化成功时，其他的线程放弃CPU时间片。只是自旋（(tab = table) == null || tab.length == 0）。当自旋过程中发现table不为空时就break，结束。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>            Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">yield</span><span style="color:#ff79c6">();</span> <span style="color:#6272a4">// lost initialization race; just spin
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 利用cas原理，只有一个线程可以初始化成功。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>                    <span style="color:#6272a4">// 默认的话 sc = 16；
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>                    <span style="color:#8be9fd">int</span> n <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>sc <span style="color:#ff79c6">&gt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> sc <span style="color:#ff79c6">:</span> DEFAULT_CAPACITY<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>                    @SuppressWarnings<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;unchecked&#34;</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>                    Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> nt <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[])</span><span style="color:#ff79c6">new</span> Node<span style="color:#ff79c6">&lt;?,?&gt;[</span>n<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>                    table <span style="color:#ff79c6">=</span> tab <span style="color:#ff79c6">=</span> nt<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>                    <span style="color:#6272a4">// n - (n/4) = (3/4)n = 12；
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>                    sc <span style="color:#ff79c6">=</span> n <span style="color:#ff79c6">-</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&gt;&gt;&gt;</span> 2<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>                <span style="color:#6272a4">// sizeCtl = 12;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>                sizeCtl <span style="color:#ff79c6">=</span> sc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#ff79c6">return</span> tab<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> SIZECTL<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">transient</span> <span style="color:#8be9fd;font-style:italic">volatile</span> <span style="color:#8be9fd">int</span> sizeCtl<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    U <span style="color:#ff79c6">=</span> sun<span style="color:#ff79c6">.</span><span style="color:#50fa7b">misc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Unsafe</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUnsafe</span><span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    Class<span style="color:#ff79c6">&lt;?&gt;</span> k <span style="color:#ff79c6">=</span> ConcurrentHashMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    SIZECTL <span style="color:#ff79c6">=</span> U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">objectFieldOffset</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>    <span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sizeCtl&#34;</span><span style="color:#ff79c6">));</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span> <span style="color:#ff79c6">}</span>
</code></pre></div><h5 id="321-sizectl">3.2.1 sizeCtl</h5>
<p>这里有必要说下sizeCtl的含义，因为后续会经常看到。
先看下官方解释：
<em><strong>Table initialization and resizing control.  When negative, the</strong></em><em><strong><strong><strong><strong>table is being initialized or resized:</strong></strong></strong></strong></em><em><strong>-1 for initialization,<strong><strong><strong>e</strong></strong></strong>lse -(1 + the number of active resizing threads).  Otherwise,<strong><strong><strong><strong><strong><strong>when table is</strong></strong></strong></strong></strong></strong>null, holds the initial table size to use upon creation, or 0 for default. After initialization, holds the</strong></em>******<em><strong>next element count value upon which to resize the table.</strong></em>
表初始化和扩容控制。如果为负数，则说明表正在初始化或扩容：-1表示初始化，-（1 +活动的调整大小线程数），表示正在扩容。当table为空时，保持创建时要使用的初始表大小，或者默认为0。初始化后，保留下一个元素计数值，以在该值上调整表的大小。
<strong>sizeCtl初始化后为12。</strong>
作用主要是两个：</p>
<ol>
<li>普通状态下表示的是阈值。</li>
<li>扩容时会变为一个绝对值很大的负数，因为concurrentHashMap有帮助扩容的逻辑，所以在多个线程帮助扩容的时候，每个线程参与扩容前都会在这个值+1（最终会保证结果仍然为负数），然后每个线程扩容结束就-1，当值恢复为最初的值时，说明整个扩容结束。具体查看3.9 transfer和3.10 transfer结束的逻辑等。</li>
</ol>
<h4 id="33-tabat">3.3 tabAt</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4">// cas的方式获取table数组第i位的值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">tabAt</span><span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;)</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getObjectVolatile</span><span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">((</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">)</span>i <span style="color:#ff79c6">&lt;&lt;</span> ASHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> ABASE<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="34-castabat">3.4 casTabAt</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4">// cas的方式设置table数组第i位的值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">casTabAt</span><span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>                                    Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> c<span style="color:#ff79c6">,</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> v<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#ff79c6">return</span> U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapObject</span><span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">((</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">)</span>i <span style="color:#ff79c6">&lt;&lt;</span> ASHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> ABASE<span style="color:#ff79c6">,</span> c<span style="color:#ff79c6">,</span> v<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="35-addcount">3.5 addCount</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4">* 增加计数，如果表太小并且尚未调整大小，则开始扩容。如果正在进行扩容，且可以* 的话就帮助扩容。扩容后重新检查占用率，以查看是否已经需要另一个扩容开始，因为扩容是* 滞后的。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4">// x 是需要加的数值，一般为1。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4">// check 如果&lt;0，则不检查扩容，如果&lt;= 1，仅检查是否无竞争。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">addCount</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span> x<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> check<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    CounterCell<span style="color:#ff79c6">[]</span> as<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">long</span> b<span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#6272a4">// counterCells不为空或者通过cas给baseCount加失败。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>as <span style="color:#ff79c6">=</span> counterCells<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#6272a4">// 只有给baseCount加失败后才会进入下面的逻辑。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 加成功后就不需要counterCell了。因为计数要么加在baseCount上，要么加在counterCells上。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">!</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapLong</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> BASECOUNT<span style="color:#ff79c6">,</span> b <span style="color:#ff79c6">=</span> baseCount<span style="color:#ff79c6">,</span> s <span style="color:#ff79c6">=</span> b <span style="color:#ff79c6">+</span> x<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        CounterCell a<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">long</span> v<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> m<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#8be9fd">boolean</span> uncontended <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>as <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>m <span style="color:#ff79c6">=</span> as<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> 0 <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            <span style="color:#ff79c6">(</span>a <span style="color:#ff79c6">=</span> as<span style="color:#ff79c6">[</span>ThreadLocalRandom<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProbe</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">&amp;</span> m<span style="color:#ff79c6">])</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            <span style="color:#6272a4">// 前边几个是初始化。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 加成功就return了，否则就进入到fullAddCount。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">!(</span>uncontended <span style="color:#ff79c6">=</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>              U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapLong</span><span style="color:#ff79c6">(</span>a<span style="color:#ff79c6">,</span> CELLVALUE<span style="color:#ff79c6">,</span> v <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">,</span> v <span style="color:#ff79c6">+</span> x<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#6272a4">// 初始化CounterCell或者更新cell的值，或者更新baseCount的值。总之一定要更新size的值。查看3.6 fullAddCount。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>            fullAddCount<span style="color:#ff79c6">(</span>x<span style="color:#ff79c6">,</span> uncontended<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#6272a4">// 如果&lt;= 1，仅检查是否无竞争。 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>check <span style="color:#ff79c6">&lt;=</span> 1<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>        <span style="color:#6272a4">// 计算concurrentHashMap的size，查看3.7 sumCount
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span style="color:#6272a4"></span>        s <span style="color:#ff79c6">=</span> sumCount<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>check <span style="color:#ff79c6">&gt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">,</span> nt<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> n<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        <span style="color:#6272a4">// sizeCtl初始化后为12。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 当size大于等于阈值后，就尝试去扩容。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 这里为什么为while呢，是因为当并发量太大时，可能刚扩容完成，紧接着又需要第二次扩容。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">&gt;=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">)(</span>sc <span style="color:#ff79c6">=</span> sizeCtl<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>               <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> MAXIMUM_CAPACITY<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>            <span style="color:#6272a4">// 扩容。查看3.8 resizeStamp。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd">int</span> rs <span style="color:#ff79c6">=</span> resizeStamp<span style="color:#ff79c6">(</span>n<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>sc <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>sc <span style="color:#ff79c6">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> rs <span style="color:#ff79c6">||</span> sc <span style="color:#ff79c6">==</span> rs <span style="color:#ff79c6">+</span> 1 <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                    sc <span style="color:#ff79c6">==</span> rs <span style="color:#ff79c6">+</span> MAX_RESIZERS <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>nt <span style="color:#ff79c6">=</span> nextTable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>                    transferIndex <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>                    <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>                    <span style="color:#6272a4">// 扩容的真正逻辑在这里。查看3.9 transfer
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span style="color:#6272a4"></span>                    transfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> nt<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>                                         <span style="color:#ff79c6">(</span>rs <span style="color:#ff79c6">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 2<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>                <span style="color:#6272a4">// 扩容的真正逻辑在这里。查看3.9 transfer
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span style="color:#6272a4"></span>                transfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>            s <span style="color:#ff79c6">=</span> sumCount<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span style="color:#ff79c6">}</span>
</code></pre></div><h5 id="351-addcount简介">3.5.1 addCount简介</h5>
<p>这里我们先简单描述下作用：其实目的就是给整个concurrentHashMap的size计数。而size计数跟两个属性相关：分别是baseCount 和 counterCells数组。size = baseCount + （counterCells数组的所有value的总和）。</p>
<h4 id="36-fulladdcount">3.6 fullAddCount</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// 刚开始调用该方法的时候，wasUncontended为false。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">fullAddCount</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span> x<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> wasUncontended<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#8be9fd">int</span> h<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>h <span style="color:#ff79c6">=</span> ThreadLocalRandom<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProbe</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        ThreadLocalRandom<span style="color:#ff79c6">.</span><span style="color:#50fa7b">localInit</span><span style="color:#ff79c6">();</span>      <span style="color:#6272a4">// force initialization
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>        h <span style="color:#ff79c6">=</span> ThreadLocalRandom<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProbe</span><span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        wasUncontended <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#8be9fd">boolean</span> collide <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>                <span style="color:#6272a4">// True if last slot nonempty
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(;;)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        CounterCell<span style="color:#ff79c6">[]</span> as<span style="color:#ff79c6">;</span> CounterCell a<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> n<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">long</span> v<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#6272a4">// counterCells已经初始化。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>as <span style="color:#ff79c6">=</span> counterCells<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">=</span> as<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            <span style="color:#6272a4">// 该线程所属的cell是空的话就进行下面的逻辑，其实就是给该位置赋值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>a <span style="color:#ff79c6">=</span> as<span style="color:#ff79c6">[(</span>n <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span> h<span style="color:#ff79c6">])</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cellsBusy <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>            <span style="color:#6272a4">// Try to attach new Cell
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"></span>                    CounterCell r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CounterCell<span style="color:#ff79c6">(</span>x<span style="color:#ff79c6">);</span> <span style="color:#6272a4">// Optimistic create
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>                    <span style="color:#6272a4">// cas的方式获取锁。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cellsBusy <span style="color:#ff79c6">==</span> 0 <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>                        U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> CELLSBUSY<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>                        <span style="color:#8be9fd">boolean</span> created <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>               <span style="color:#6272a4">// Recheck under lock
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#6272a4"></span>                            CounterCell<span style="color:#ff79c6">[]</span> rs<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> m<span style="color:#ff79c6">,</span> j<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>                            <span style="color:#6272a4">// 双重检查，确实为空的话就给该位置赋值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#6272a4"></span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>rs <span style="color:#ff79c6">=</span> counterCells<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>                                <span style="color:#ff79c6">(</span>m <span style="color:#ff79c6">=</span> rs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span> 0 <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>                                rs<span style="color:#ff79c6">[</span>j <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>m <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span> h<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>                                rs<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> r<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>                                created <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>                        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>                            cellsBusy <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                        <span style="color:#6272a4">// 初始化成功就结束。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span style="color:#6272a4"></span>                        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>created<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                        <span style="color:#6272a4">// 不成功的话就接着循环。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span style="color:#6272a4"></span>                        <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>           <span style="color:#6272a4">// Slot is now non-empty
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                collide <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>wasUncontended<span style="color:#ff79c6">)</span>       <span style="color:#6272a4">// CAS already known to fail
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span style="color:#6272a4"></span>                wasUncontended <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>      <span style="color:#6272a4">// Continue after rehash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 走到这里说明该线程的hash值对应的位置的cell已经初始化。就尝试更新该位置的值，更新成功就结束循环。更新失败就接着走下边的逻辑。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapLong</span><span style="color:#ff79c6">(</span>a<span style="color:#ff79c6">,</span> CELLVALUE<span style="color:#ff79c6">,</span> v <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">,</span> v <span style="color:#ff79c6">+</span> x<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>            <span style="color:#6272a4">// counterCells已经被别的线程扩容了。或者大小已经到了最大值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>counterCells <span style="color:#ff79c6">!=</span> as <span style="color:#ff79c6">||</span> n <span style="color:#ff79c6">&gt;=</span> NCPU<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>                collide <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>            <span style="color:#6272a4">// At max size or stale
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>collide<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>                collide <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>            <span style="color:#6272a4">// 扩容
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cellsBusy <span style="color:#ff79c6">==</span> 0 <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>                     U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> CELLSBUSY<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>counterCells <span style="color:#ff79c6">==</span> as<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span><span style="color:#6272a4">// Expand table unless stale
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span style="color:#6272a4"></span>                        CounterCell<span style="color:#ff79c6">[]</span> rs <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CounterCell<span style="color:#ff79c6">[</span>n <span style="color:#ff79c6">&lt;&lt;</span> 1<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>                        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> n<span style="color:#ff79c6">;</span> <span style="color:#ff79c6">++</span>i<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>                            rs<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> as<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>                        counterCells <span style="color:#ff79c6">=</span> rs<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>                    cellsBusy <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>                collide <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>                <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>                   <span style="color:#6272a4">// Retry with expanded table
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>            <span style="color:#6272a4">// 获取线程的新的hashcode。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 走到这一步说明CounterCell竞争太激烈了，就做两个操作，一是给CounterCell扩容，二是更新该线程的hashcode，目的是减少hash碰撞。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span><span style="color:#6272a4"></span>            h <span style="color:#ff79c6">=</span> ThreadLocalRandom<span style="color:#ff79c6">.</span><span style="color:#50fa7b">advanceProbe</span><span style="color:#ff79c6">(</span>h<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>        <span style="color:#6272a4">// 初始化的时候会走这里。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cellsBusy <span style="color:#ff79c6">==</span> 0 <span style="color:#ff79c6">&amp;&amp;</span> counterCells <span style="color:#ff79c6">==</span> as <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span>                 U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> CELLSBUSY<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76</span>            <span style="color:#8be9fd">boolean</span> init <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77</span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span><span style="color:#6272a4">// Initialize table
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">// 双重检查，如果不相等说明counterCells已经被其他线程初始化。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>counterCells <span style="color:#ff79c6">==</span> as<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80</span>                    <span style="color:#6272a4">// 初始化CounterCells数组。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81</span><span style="color:#6272a4"></span>                    CounterCell<span style="color:#ff79c6">[]</span> rs <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CounterCell<span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82</span>                    rs<span style="color:#ff79c6">[</span>h <span style="color:#ff79c6">&amp;</span> 1<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CounterCell<span style="color:#ff79c6">(</span>x<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83</span>                    counterCells <span style="color:#ff79c6">=</span> rs<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84</span>                    init <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86</span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87</span>                cellsBusy <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>init<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92</span>        <span style="color:#6272a4">// 尝试更新baseCount的值，如果更新成功也结束循环。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapLong</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> BASECOUNT<span style="color:#ff79c6">,</span> v <span style="color:#ff79c6">=</span> baseCount<span style="color:#ff79c6">,</span> v <span style="color:#ff79c6">+</span> x<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94</span>            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>                          <span style="color:#6272a4">// Fall back on using base
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>这里的逻辑主要分三个大的分支：</p>
<ol>
<li>counterCells有值。更新该线程的hash值对应的cell的value，加失败就尝试扩容并更新该线程的hashcode。</li>
<li>counterCells未初始化。并初始化该线程的hashcode对应的cell且赋值。</li>
<li>直接给baseCount 加 1。</li>
</ol>
<p>上述分支只要进去一个就结束循环，否则就接着循环。</p>
<h4 id="37-sumcount">3.7 sumCount</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// concurrentHashMap的size
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> <span style="color:#50fa7b">sumCount</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    CounterCell<span style="color:#ff79c6">[]</span> as <span style="color:#ff79c6">=</span> counterCells<span style="color:#ff79c6">;</span> CounterCell a<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd">long</span> sum <span style="color:#ff79c6">=</span> baseCount<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#6272a4">// size = baseCount  + sum(counterCell[i].value)。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>as <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> as<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span> <span style="color:#ff79c6">++</span>i<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>a <span style="color:#ff79c6">=</span> as<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">])</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>                sum <span style="color:#ff79c6">+=</span> a<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#ff79c6">return</span> sum<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="38-resizestamp">3.8 resizeStamp</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#6272a4">* 这个方法不太明白。目的就是返回一个值很大的负数。可以查看3.2.1 sizeCtl。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">resizeStamp</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>    <span style="color:#ff79c6">return</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">numberOfLeadingZeros</span><span style="color:#ff79c6">(</span>n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">(</span>1 <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#ff79c6">(</span>RESIZE_STAMP_BITS <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">));</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>官方注释：
<em><strong>Returns the stamp bits for resizing a table of size n.</strong></em>
<em><strong>Must be negative when shifted left by RESIZE_STAMP_SHIFT.</strong></em>
大致意思就是：
<em><strong>返回用于调整大小为n的表的标记位。 向左移动RESIZE_STAMP_SHIFT时一定为负数。</strong></em></p>
<h4 id="39-transfer">3.9 transfer</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transfer</span><span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">,</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> nextTab<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span>    <span style="color:#6272a4">// stride 步长。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> n <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">,</span> stride<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>stride <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>NCPU <span style="color:#ff79c6">&gt;</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&gt;&gt;&gt;</span> 3<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">/</span> NCPU <span style="color:#ff79c6">:</span> n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> MIN_TRANSFER_STRIDE<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span>        stride <span style="color:#ff79c6">=</span> MIN_TRANSFER_STRIDE<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// subdivide range
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 这一段是初始化新的table。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>nextTab <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>            <span style="color:#6272a4">// initiating
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span>            @SuppressWarnings<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;unchecked&#34;</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span>            Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> nt <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[])</span><span style="color:#ff79c6">new</span> Node<span style="color:#ff79c6">&lt;?,?&gt;[</span>n <span style="color:#ff79c6">&lt;&lt;</span> 1<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span>            nextTab <span style="color:#ff79c6">=</span> nt<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable ex<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>      <span style="color:#6272a4">// try to cope with OOME
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span style="color:#6272a4"></span>            sizeCtl <span style="color:#ff79c6">=</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MAX_VALUE</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span>            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span>        nextTable <span style="color:#ff79c6">=</span> nextTab<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span>        transferIndex <span style="color:#ff79c6">=</span> n<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span>    <span style="color:#8be9fd">int</span> nextn <span style="color:#ff79c6">=</span> nextTab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span>    ForwardingNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> fwd <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ForwardingNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>nextTab<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span>    <span style="color:#8be9fd">boolean</span> advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span>    <span style="color:#8be9fd">boolean</span> finishing <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// to ensure sweep before committing nextTab
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">,</span> bound <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;;)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span>        Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> f<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> fh<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span>        <span style="color:#6272a4">// 这个while循环的目的就是获取该线程可以帮助扩容的table数组的范围。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 标记出需要扩容的index的值，也就是结束的位置，然后根据步长计算出最开始的位置，接着就帮助转移元素到新的数组。 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>advance<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span>            <span style="color:#6272a4">// nextIndex就是需要负责的范围的结束的位置。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// nextBound就是需要负责的范围的开始的位置。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd">int</span> nextIndex<span style="color:#ff79c6">,</span> nextBound<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(--</span>i <span style="color:#ff79c6">&gt;=</span> bound <span style="color:#ff79c6">||</span> finishing<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span>                advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>nextIndex <span style="color:#ff79c6">=</span> transferIndex<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span>                i <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span>                advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span>                     <span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> TRANSFERINDEX<span style="color:#ff79c6">,</span> nextIndex<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span>                      nextBound <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>nextIndex <span style="color:#ff79c6">&gt;</span> stride <span style="color:#ff79c6">?</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span>                                   nextIndex <span style="color:#ff79c6">-</span> stride <span style="color:#ff79c6">:</span> 0<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span>                <span style="color:#6272a4">// 算出该线程负责的范围的开始和结束位置。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span><span style="color:#6272a4"></span>                bound <span style="color:#ff79c6">=</span> nextBound<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span>                i <span style="color:#ff79c6">=</span> nextIndex <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span>                advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span>        <span style="color:#6272a4">// 这里需要详细说明下，我们单独摘出来解释。查看 3.10 transfer结束的逻辑。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;</span> 0 <span style="color:#ff79c6">||</span> i <span style="color:#ff79c6">&gt;=</span> n <span style="color:#ff79c6">||</span> i <span style="color:#ff79c6">+</span> n <span style="color:#ff79c6">&gt;=</span> nextn<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span>            <span style="color:#8be9fd">int</span> sc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>finishing<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span>                nextTable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span>                table <span style="color:#ff79c6">=</span> nextTab<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span>                sizeCtl <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&lt;&lt;</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&gt;&gt;&gt;</span> 1<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span>                <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">=</span> sizeCtl<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>sc <span style="color:#ff79c6">-</span> 2<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> resizeStamp<span style="color:#ff79c6">(</span>n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span>                    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span>                finishing <span style="color:#ff79c6">=</span> advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span>                i <span style="color:#ff79c6">=</span> n<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// recheck before commit
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span>        <span style="color:#6272a4">// 第i个位置为空的话说明不需要转移。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>f <span style="color:#ff79c6">=</span> tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span>            <span style="color:#6272a4">// 直接在该位置设置值为ForwardingNode，ForwardingNode的意思查看3.9.2 ForwardingNode
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span><span style="color:#6272a4"></span>            advance <span style="color:#ff79c6">=</span> casTabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> fwd<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>fh <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> MOVED<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span>            <span style="color:#6272a4">// 已经被设置为ForwardingNode了，说明自己负责的区域已经完成了。那么就需要接着前进，看下是否有其他地方需要自己帮忙扩容。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span><span style="color:#6272a4"></span>            advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// already processed
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span>            <span style="color:#6272a4">// 说明这个位置有值，就需要转移元素。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 分两种情况。一种是链表，一种是红黑树。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span>                    Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> ln<span style="color:#ff79c6">,</span> hn<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>fh <span style="color:#ff79c6">&gt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span>                        <span style="color:#6272a4">// 链表的话就跟1.8的hashMap一样，分高低位转移。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span style="color:#6272a4"></span>                        <span style="color:#8be9fd">int</span> runBit <span style="color:#ff79c6">=</span> fh <span style="color:#ff79c6">&amp;</span> n<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span>                        Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> lastRun <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span>                        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> p <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">;</span> p <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span> p <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span>                            <span style="color:#8be9fd">int</span> b <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">&amp;</span> n<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>b <span style="color:#ff79c6">!=</span> runBit<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span>                                runBit <span style="color:#ff79c6">=</span> b<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span>                                lastRun <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span>                        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>runBit <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span>                            ln <span style="color:#ff79c6">=</span> lastRun<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span>                            hn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span>                        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span>                            hn <span style="color:#ff79c6">=</span> lastRun<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span>                            ln <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span>                        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> p <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">;</span> p <span style="color:#ff79c6">!=</span> lastRun<span style="color:#ff79c6">;</span> p <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span>                            <span style="color:#8be9fd">int</span> ph <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">;</span> K pk <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">;</span> V pv <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>ph <span style="color:#ff79c6">&amp;</span> n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span>                                ln <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>ph<span style="color:#ff79c6">,</span> pk<span style="color:#ff79c6">,</span> pv<span style="color:#ff79c6">,</span> ln<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span>                            <span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span>                                hn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>ph<span style="color:#ff79c6">,</span> pk<span style="color:#ff79c6">,</span> pv<span style="color:#ff79c6">,</span> hn<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span>                        setTabAt<span style="color:#ff79c6">(</span>nextTab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> ln<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span>                        setTabAt<span style="color:#ff79c6">(</span>nextTab<span style="color:#ff79c6">,</span> i <span style="color:#ff79c6">+</span> n<span style="color:#ff79c6">,</span> hn<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span>                        setTabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> fwd<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span>                        advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span>                    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>f <span style="color:#ff79c6">instanceof</span> TreeBin<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span>                        <span style="color:#6272a4">// 树的话就走树的转移逻辑。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span><span style="color:#6272a4"></span>                        TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> t <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;)</span>f<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span>                        TreeNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> lo <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> loTail <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span>                        TreeNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> hi <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> hiTail <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span>                        <span style="color:#8be9fd">int</span> lc <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">,</span> hc <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span>                        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> t<span style="color:#ff79c6">.</span><span style="color:#50fa7b">first</span><span style="color:#ff79c6">;</span> e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span> e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span>                            <span style="color:#8be9fd">int</span> h <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span>                            TreeNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> p <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TreeNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span>                                <span style="color:#ff79c6">(</span>h<span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>h <span style="color:#ff79c6">&amp;</span> n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span>                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prev</span> <span style="color:#ff79c6">=</span> loTail<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span>                                    lo <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span>                                <span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span>                                    loTail<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span>                                loTail <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span>                                <span style="color:#ff79c6">++</span>lc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span>                            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span>                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prev</span> <span style="color:#ff79c6">=</span> hiTail<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span>                                    hi <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span>                                <span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span>                                    hiTail<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span>                                hiTail <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span>                                <span style="color:#ff79c6">++</span>hc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span>                        ln <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>lc <span style="color:#ff79c6">&lt;=</span> UNTREEIFY_THRESHOLD<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> untreeify<span style="color:#ff79c6">(</span>lo<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span>                            <span style="color:#ff79c6">(</span>hc <span style="color:#ff79c6">!=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">new</span> TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>lo<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> t<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span>                        hn <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>hc <span style="color:#ff79c6">&lt;=</span> UNTREEIFY_THRESHOLD<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> untreeify<span style="color:#ff79c6">(</span>hi<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span>                            <span style="color:#ff79c6">(</span>lc <span style="color:#ff79c6">!=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">new</span> TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;(</span>hi<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> t<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span>                        setTabAt<span style="color:#ff79c6">(</span>nextTab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> ln<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span>                        setTabAt<span style="color:#ff79c6">(</span>nextTab<span style="color:#ff79c6">,</span> i <span style="color:#ff79c6">+</span> n<span style="color:#ff79c6">,</span> hn<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">140</span>                        setTabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> fwd<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">141</span>                        advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">142</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">143</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">144</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">145</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">146</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">147</span><span style="color:#ff79c6">}</span>
</code></pre></div><h5 id="391-前言">3.9.1 前言</h5>
<p>这个方法的目的就是多个线程一起扩容，也利用到了分段的思想。分段就是基于stride(步长)，每个线程根据oldTable的index，倒着转移元素。每次负责的元素范围就是从index开始，往前数stride个值。自己负责的扩容完成之后会看还有没有需要扩容的，有的话就接着扩容，没有的话就等待其他线程扩容结束或者整个扩容逻辑就结束了。</p>
<h5 id="392-forwardingnode">3.9.2 ForwardingNode</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ForwardingNode</span><span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd;font-style:italic">extends</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#8be9fd;font-style:italic">final</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> nextTable<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    ForwardingNode<span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>MOVED<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextTable</span> <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> MOVED     <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// hash for forwarding nodes
</span></code></pre></div><p>ForwardingNode的只是为了占位，意思有两个：</p>
<ol>
<li>表明这个位置原来的值为null。</li>
<li>表示这个concurrentHashMap的table正在扩容。</li>
</ol>
<h4 id="310-transfer结束的逻辑">3.10 transfer结束的逻辑</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// 当扩容完成时，会走到这个逻辑。比如i = -1时。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;</span> 0 <span style="color:#ff79c6">||</span> i <span style="color:#ff79c6">&gt;=</span> n <span style="color:#ff79c6">||</span> i <span style="color:#ff79c6">+</span> n <span style="color:#ff79c6">&gt;=</span> nextn<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>            <span style="color:#8be9fd">int</span> sc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>            <span style="color:#6272a4">// 最后一个transfer线程走到这里。此时finishingfinishing = true。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>finishing<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>                <span style="color:#6272a4">// 把table指向扩容后的表。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>                nextTable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>                table <span style="color:#ff79c6">=</span> nextTab<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>                <span style="color:#6272a4">// 阈值。就等于n *2 - n / 2 = n * 3/2 = 3/4 * 2n。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>                sizeCtl <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&lt;&lt;</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&gt;&gt;&gt;</span> 1<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>                <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            <span style="color:#6272a4">// 最开始先到这里。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">//  sc - 1的意义查看 3.10.1 sc - 1的意义。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">=</span> sizeCtl<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>                <span style="color:#6272a4">// 查看3.10.2 transfer 前sc 的初始值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">// sc不等于初始值的话，说明所有的transfer线程还未全部结束，直接return。该线程结束。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>sc <span style="color:#ff79c6">-</span> 2<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> resizeStamp<span style="color:#ff79c6">(</span>n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>                    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>                <span style="color:#6272a4">// sc等于初始值的话，说明所有的transfer线程全部结束，当前线程是最后一个线程。finishing 、advance 均置为true，进行下一个循环。其实 就会走到该段代码的第4行。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#6272a4"></span>                finishing <span style="color:#ff79c6">=</span> advance <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                i <span style="color:#ff79c6">=</span> n<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// recheck before commit
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#ff79c6">}</span>
</code></pre></div><h5 id="3101-sc---1的意义">3.10.1 sc - 1的意义</h5>
<p>其实在3.10 这段代码的上游的逻辑是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">&gt;=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">)(</span>sc <span style="color:#ff79c6">=</span> sizeCtl<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>       <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> MAXIMUM_CAPACITY<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#8be9fd">int</span> rs <span style="color:#ff79c6">=</span> resizeStamp<span style="color:#ff79c6">(</span>n<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>sc <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>sc <span style="color:#ff79c6">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> rs <span style="color:#ff79c6">||</span> sc <span style="color:#ff79c6">==</span> rs <span style="color:#ff79c6">+</span> 1 <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            sc <span style="color:#ff79c6">==</span> rs <span style="color:#ff79c6">+</span> MAX_RESIZERS <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>nt <span style="color:#ff79c6">=</span> nextTable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            transferIndex <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#6272a4">// 除了初始化外，每次transfer之前都会给sc + 1。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>            transfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> nt<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>                                 <span style="color:#ff79c6">(</span>rs <span style="color:#ff79c6">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 2<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        transfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    s <span style="color:#ff79c6">=</span> sumCount<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>所以每个线程transfer结束后就 sc -1。</p>
<h5 id="3102-transfer-前sc-的初始值">3.10.2 transfer 前sc 的初始值。</h5>
<p>根据3.10.1 sc - 1的意义第14行代码可知，在transfer之前，sc的初始值为
（resizeStamp(n)  &laquo;  RESIZE_STAMP_SHIFT） + 2。
而在3.10 transfer结束的逻辑里第14行需要判断
(sc - 2) != resizeStamp(n) &laquo; RESIZE_STAMP_SHIFT
其实就是判断是否变回到初始值。</p>
<h4 id="311-helptransfer">3.11 helpTransfer</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">final</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> <span style="color:#50fa7b">helpTransfer</span><span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">,</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> nextTab<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> sc<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>tab <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>f <span style="color:#ff79c6">instanceof</span> ForwardingNode<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#ff79c6">(</span>nextTab <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">((</span>ForwardingNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;)</span>f<span style="color:#ff79c6">).</span><span style="color:#50fa7b">nextTable</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        <span style="color:#8be9fd">int</span> rs <span style="color:#ff79c6">=</span> resizeStamp<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>nextTab <span style="color:#ff79c6">==</span> nextTable <span style="color:#ff79c6">&amp;&amp;</span> table <span style="color:#ff79c6">==</span> tab <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>               <span style="color:#ff79c6">(</span>sc <span style="color:#ff79c6">=</span> sizeCtl<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>            <span style="color:#6272a4">// 正在扩容就帮助扩容，主要逻辑还是在3.9 transfer。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>sc <span style="color:#ff79c6">&gt;&gt;&gt;</span> RESIZE_STAMP_SHIFT<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> rs <span style="color:#ff79c6">||</span> sc <span style="color:#ff79c6">==</span> rs <span style="color:#ff79c6">+</span> 1 <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>                sc <span style="color:#ff79c6">==</span> rs <span style="color:#ff79c6">+</span> MAX_RESIZERS <span style="color:#ff79c6">||</span> transferIndex <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>U<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSwapInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> SIZECTL<span style="color:#ff79c6">,</span> sc<span style="color:#ff79c6">,</span> sc <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>                transfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> nextTab<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#ff79c6">return</span> nextTab<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#ff79c6">return</span> table<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>至此，put方法完全结束。</p>
<h3 id="4get-方法">4.get 方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// get方法非常简单，不再赘述。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> V <span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab<span style="color:#ff79c6">;</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e<span style="color:#ff79c6">,</span> p<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> n<span style="color:#ff79c6">,</span> eh<span style="color:#ff79c6">;</span> K ek<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#8be9fd">int</span> h <span style="color:#ff79c6">=</span> spread<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span> 0 <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        <span style="color:#ff79c6">(</span>e <span style="color:#ff79c6">=</span> tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span> h<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>eh <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> h<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>ek <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>ek <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>ek<span style="color:#ff79c6">)))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>                <span style="color:#ff79c6">return</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>eh <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>p <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">find</span><span style="color:#ff79c6">(</span>h<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">((</span>e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> h <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>                <span style="color:#ff79c6">((</span>ek <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>ek <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>ek<span style="color:#ff79c6">))))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>                <span style="color:#ff79c6">return</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="5remove方法">5.remove方法</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">public</span> V <span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">return</span> replaceNode<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#8be9fd;font-style:italic">final</span> V <span style="color:#50fa7b">replaceNode</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">,</span> Object cv<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> spread<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> tab <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">;;)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> f<span style="color:#ff79c6">;</span> <span style="color:#8be9fd">int</span> n<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> fh<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>tab <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">=</span> tab<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> 0 <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#ff79c6">(</span>f <span style="color:#ff79c6">=</span> tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span> hash<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>fh <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> MOVED<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            tab <span style="color:#ff79c6">=</span> helpTransfer<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> f<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>            V oldVal <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            <span style="color:#8be9fd">boolean</span> validated <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>tabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> f<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>fh <span style="color:#ff79c6">&gt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>                        validated <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>                        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> f<span style="color:#ff79c6">,</span> pred <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;;)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>                            K ek<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>                                <span style="color:#ff79c6">((</span>ek <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>                                 <span style="color:#ff79c6">(</span>ek <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>ek<span style="color:#ff79c6">))))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>                                V ev <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cv <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> cv <span style="color:#ff79c6">==</span> ev <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>                                    <span style="color:#ff79c6">(</span>ev <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> cv<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>ev<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>                                    oldVal <span style="color:#ff79c6">=</span> ev<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>                                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>                                        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>                                    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>pred <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>                                        pred<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>                                    <span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>                                        setTabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>                                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>                                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>                            pred <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>                    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>f <span style="color:#ff79c6">instanceof</span> TreeBin<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>                        validated <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>                        TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> t <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>TreeBin<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;)</span>f<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>                        TreeNode<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> r<span style="color:#ff79c6">,</span> p<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>                        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>r <span style="color:#ff79c6">=</span> t<span style="color:#ff79c6">.</span><span style="color:#50fa7b">root</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>                            <span style="color:#ff79c6">(</span>p <span style="color:#ff79c6">=</span> r<span style="color:#ff79c6">.</span><span style="color:#50fa7b">findTreeNode</span><span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>                            V pv <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cv <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">||</span> cv <span style="color:#ff79c6">==</span> pv <span style="color:#ff79c6">||</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>                                <span style="color:#ff79c6">(</span>pv <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> cv<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>pv<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>                                oldVal <span style="color:#ff79c6">=</span> pv<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span>                                    p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">val</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span>                                <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>t<span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeTreeNode</span><span style="color:#ff79c6">(</span>p<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span>                                    setTabAt<span style="color:#ff79c6">(</span>tab<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">,</span> untreeify<span style="color:#ff79c6">(</span>t<span style="color:#ff79c6">.</span><span style="color:#50fa7b">first</span><span style="color:#ff79c6">));</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span>                            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>                        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>                    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>validated<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>oldVal <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>                        <span style="color:#6272a4">// 主要是这里需要说明下。可以查看3.5 addCount。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span><span style="color:#6272a4"></span>                        addCount<span style="color:#ff79c6">(-</span>1L<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span>                    <span style="color:#ff79c6">return</span> oldVal<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69</span>                <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70</span>                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75</span><span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="参考资料">参考资料</h3>
<p><a href="https://www.bilibili.com/video/BV1x741117jq?t=2998&amp;p=2">详解hashMap-B站-鲁班学院-周瑜</a></p>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  You 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
