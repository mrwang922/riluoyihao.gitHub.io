<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> HashMap1 | wdl&#39;s blog</title>
  <link rel = 'canonical' href = 'https://riluoyihao.github.io/post/hashmap1.7/'>
  <meta name="description" content="Java学习笔记">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="HashMap1" />
<meta property="og:description" content="HashMap 1.7 1. 初始化 1.1 主要是几个属性： 1static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // 默认的初始化容量，值为 2^4 也就是16 2static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30; // 最大容量 2^30 也就是1073741824 3static final float DEFAULT_LOAD_FACTOR = 0.75f; // 默认负载因子 4static final Entry&lt;?,?&gt;[] EMPTY_TABLE = {}; // 空的entry数组 5transient Entry&lt;K,V&gt;[] table = (Entry&lt;K,V&gt;[]) EMPTY_TABLE; // 扩容需要的entry数组，长度必须是2的整数次幂，原因会在后面讲 6transient int size; // map中所有的键值对数量，注意不是entry数组的元素个数 7transient int modCount; // 修改次数，后续会详细说 8static final int ALTERNATIVE_HASHING_THRESHOLD_DEFAULT = Integer.MAX_VALUE; // 大意是说是一个默认的阈值，当一个键值对的键是String类型时，且map的容量达到了这个阈值，就启用备用哈希（alternative hashing）。备用哈希可以减少String类型的key计算哈希码（更容易）发生哈希碰撞的发生率。该值可以通过定义系统属性jdk." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://riluoyihao.github.io/post/hashmap1.7/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-08-01T20:02:31&#43;08:00" />
<meta property="article:modified_time" content="2021-08-01T20:02:31&#43;08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HashMap1"/>
<meta name="twitter:description" content="HashMap 1.7 1. 初始化 1.1 主要是几个属性： 1static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // 默认的初始化容量，值为 2^4 也就是16 2static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30; // 最大容量 2^30 也就是1073741824 3static final float DEFAULT_LOAD_FACTOR = 0.75f; // 默认负载因子 4static final Entry&lt;?,?&gt;[] EMPTY_TABLE = {}; // 空的entry数组 5transient Entry&lt;K,V&gt;[] table = (Entry&lt;K,V&gt;[]) EMPTY_TABLE; // 扩容需要的entry数组，长度必须是2的整数次幂，原因会在后面讲 6transient int size; // map中所有的键值对数量，注意不是entry数组的元素个数 7transient int modCount; // 修改次数，后续会详细说 8static final int ALTERNATIVE_HASHING_THRESHOLD_DEFAULT = Integer.MAX_VALUE; // 大意是说是一个默认的阈值，当一个键值对的键是String类型时，且map的容量达到了这个阈值，就启用备用哈希（alternative hashing）。备用哈希可以减少String类型的key计算哈希码（更容易）发生哈希碰撞的发生率。该值可以通过定义系统属性jdk."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://riluoyihao.github.io/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css" integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://riluoyihao.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://riluoyihao.github.io/">
  
    <div id="logo" style="background-image: url(https://riluoyihao.github.io/images/logo.png)"></div>
  
  <div id="title">
    <h1>wdl&#39;s blog</h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#" aria-label="Menu"><i class="fas fa-bars fa-2x" aria-hidden="true"></i></a>
      </li>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/posts">Writings</a></li>
      
        <li><a href="/tags">Tags</a></li>
      
        <li><a href="/about">About</a></li>
      
    </ul>
  </div>
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h1 id="hashmap-17">HashMap 1.7</h1>
<h3 id="1-初始化">1. 初始化</h3>
<h4 id="11--主要是几个属性">1.1  主要是几个属性：</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> DEFAULT_INITIAL_CAPACITY <span style="color:#ff79c6">=</span> 1 <span style="color:#ff79c6">&lt;&lt;</span> 4<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 默认的初始化容量，值为 2^4 也就是16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> MAXIMUM_CAPACITY <span style="color:#ff79c6">=</span> 1 <span style="color:#ff79c6">&lt;&lt;</span> 30<span style="color:#ff79c6">;</span>  <span style="color:#6272a4">// 最大容量  2^30  也就是1073741824
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">float</span> DEFAULT_LOAD_FACTOR <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">75f</span><span style="color:#ff79c6">;</span>  <span style="color:#6272a4">// 默认负载因子
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Entry<span style="color:#ff79c6">&lt;?,?&gt;[]</span> EMPTY_TABLE <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{};</span> <span style="color:#6272a4">// 空的entry数组
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">transient</span> Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> table <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[])</span> EMPTY_TABLE<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 扩容需要的entry数组，长度必须是2的整数次幂，原因会在后面讲
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">transient</span> <span style="color:#8be9fd">int</span> size<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// map中所有的键值对数量，注意不是entry数组的元素个数
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">transient</span> <span style="color:#8be9fd">int</span> modCount<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 修改次数，后续会详细说
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> ALTERNATIVE_HASHING_THRESHOLD_DEFAULT <span style="color:#ff79c6">=</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MAX_VALUE</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 大意是说是一个默认的阈值，当一个键值对的键是String类型时，且map的容量达到了这个阈值，就启用备用哈希（alternative hashing）。备用哈希可以减少String类型的key计算哈希码（更容易）发生哈希碰撞的发生率。该值可以通过定义系统属性jdk.map.althashing.threshold来指定。如果该值是1，表示强制总是使用备用哈希；如果是-1则表示禁用。 这个跟内部类Holder有关，而holder又跟扩容有关。TODO
</span></code></pre></div><h4 id="12-构造方法有四个">1.2 构造方法有四个</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">()</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> initialCapacity<span style="color:#ff79c6">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> initialCapacity<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">float</span> loadFactor<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">(</span>Map<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> K<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">extends</span> V<span style="color:#ff79c6">&gt;</span> m<span style="color:#ff79c6">)</span>
</code></pre></div><ul>
<li>调用关系如下图</li>
</ul>
<p><img src="../../images/HashMap1.7/hashmap%E5%88%9D%E5%A7%8B%E5%8C%96.png" alt="hashmap初始化"></p>
<p>所以这里要介绍 <em><strong>public HashMap(int initialCapacity, float loadFactor)</strong></em></p>
<ul>
<li><strong>HashMap(int initialCapacity, float loadFactor)</strong></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">// 其实非常简单，这里只是校验下初始化的容量和阈值。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> initialCapacity<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">float</span> loadFactor<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>initialCapacity <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IllegalArgumentException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Illegal initial capacity: &#34;</span> <span style="color:#ff79c6">+</span>initialCapacity<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>initialCapacity <span style="color:#ff79c6">&gt;</span> MAXIMUM_CAPACITY<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        initialCapacity <span style="color:#ff79c6">=</span> MAXIMUM_CAPACITY<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>loadFactor <span style="color:#ff79c6">&lt;=</span> 0 <span style="color:#ff79c6">||</span> Float<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isNaN</span><span style="color:#ff79c6">(</span>loadFactor<span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IllegalArgumentException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Illegal load factor: &#34;</span> <span style="color:#ff79c6">+</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>                                           loadFactor<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#6272a4">// 由上述可知，容量的大小为1---MAXIMUM_CAPACITY也就是2的30次幂之间
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadFactor</span> <span style="color:#ff79c6">=</span> loadFactor<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    threshold <span style="color:#ff79c6">=</span> initialCapacity<span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 阈值也与初始化容量大小一样
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    init<span style="color:#ff79c6">();</span> <span style="color:#6272a4">// 这个方法是父类的方法，LinkedHashMap使用了，这里没有使用
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>HashMap(Map&lt;? extends K, ? extends V&gt; m)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">(</span>Map<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">extends</span> K<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">extends</span> V<span style="color:#ff79c6">&gt;</span> m<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#ff79c6">this</span><span style="color:#ff79c6">(</span>Math<span style="color:#ff79c6">.</span><span style="color:#50fa7b">max</span><span style="color:#ff79c6">((</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">(</span>m<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">/</span> DEFAULT_LOAD_FACTOR<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">,</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>                  DEFAULT_INITIAL_CAPACITY<span style="color:#ff79c6">),</span> DEFAULT_LOAD_FACTOR<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#6272a4">// 这个需要重点解析下，因为在后续初始化entry数组的时候还会遇到
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#6272a4"></span>    inflateTable<span style="color:#ff79c6">(</span>threshold<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>    <span style="color:#6272a4">// 因为这个方法与createEntry有关，我们后续会详细分析createEntry，到时候会提到这个方法
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span style="color:#6272a4"></span>    putAllForCreate<span style="color:#ff79c6">(</span>m<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>详解inflateTable(int toSize)
<ul>
<li>首先这个方法的名称含义为：表膨胀，从名字中我们也可以猜到，跟map的扩容有关，所以这个方法需要好好分析下</li>
<li>我们把相关的方法一起复制过来，然后分析</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4">* 膨胀表
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">inflateTable</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> toSize<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#6272a4">// Find a power of 2 &gt;= toSize
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//找出不小于所给值且为2的n次幂的值，至于为什么会是2的n次幂，我们接下来也会分析TODO
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> capacity <span style="color:#ff79c6">=</span> roundUpToPowerOf2<span style="color:#ff79c6">(</span>toSize<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#6272a4">// 阈值为容量 * 负载因子
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    threshold <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span> Math<span style="color:#ff79c6">.</span><span style="color:#50fa7b">min</span><span style="color:#ff79c6">(</span>capacity <span style="color:#ff79c6">*</span> loadFactor<span style="color:#ff79c6">,</span> MAXIMUM_CAPACITY <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    table <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Entry<span style="color:#ff79c6">[</span>capacity<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    initHashSeedAsNeeded<span style="color:#ff79c6">(</span>capacity<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#6272a4">* 这个方法的目的就是找出不小于传入值，且为2的n次幂的值
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">roundUpToPowerOf2</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> number<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#6272a4">// assert number &gt;= 0 : &#34;number must be non-negative&#34;;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span style="color:#6272a4"></span>   <span style="color:#ff79c6">return</span> number <span style="color:#ff79c6">&gt;=</span> MAXIMUM_CAPACITY
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#ff79c6">?</span> MAXIMUM_CAPACITY
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>            <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">(</span>number <span style="color:#ff79c6">&gt;</span> 1<span style="color:#ff79c6">)?</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">highestOneBit</span><span style="color:#ff79c6">((</span>number <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;&lt;</span> 1<span style="color:#ff79c6">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>                <span style="color:#ff79c6">:</span> 1<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>
<ul>
<li>先来说roundUpToPowerOf2</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">roundUpToPowerOf2</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> number<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#6272a4">// assert number &gt;= 0 : &#34;number must be non-negative&#34;;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#6272a4"></span>   <span style="color:#ff79c6">return</span> number <span style="color:#ff79c6">&gt;=</span> MAXIMUM_CAPACITY
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>            <span style="color:#ff79c6">?</span> MAXIMUM_CAPACITY
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>            <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">(</span>number <span style="color:#ff79c6">&gt;</span> 1<span style="color:#ff79c6">)?</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">highestOneBit</span><span style="color:#ff79c6">((</span>number <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;&lt;</span> 1<span style="color:#ff79c6">)</span> 
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span>                <span style="color:#ff79c6">:</span> 1<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>
<ul>
<li>
<ul>
<li>根据 <a href="https://riluoyihao.github.io/post/integer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Integer源码分析</a>我们可知Integer.highestOneBit(number)得到的就是小于等于num且为2的n次幂的最大数。</li>
<li>左移一位表示把这个数翻倍。</li>
<li>减一是为了处理特殊情况，比如<em>number</em>恰巧为8，16，32等等。</li>
<li>由上述可知，roundUpToPowerOf2方法的目的即为获取大于等于number的最小2的n次幂的值。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>由上，我们可知inflateTable前三行的意思了：根据传入的capacity可以得到大于等于传入的capacity的最小的2的n次幂的值。然后根据这个容量大小初始化一个空的Entry数组。</li>
</ul>
</li>
<li>
<ul>
<li>再来说initHashSeedAsNeeded</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">initHashSeedAsNeeded</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> capacity<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>   <span style="color:#6272a4">// 因为hashSeed初始化就是为0，所以首次调用该方法时currentAltHashing即为false
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">boolean</span> currentAltHashing <span style="color:#ff79c6">=</span> hashSeed <span style="color:#ff79c6">!=</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#6272a4">// 一般情况下，sun.misc.VM.isBooted()为true
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 一般情况下，capacity &gt;= Holder.ALTERNATIVE_HASHING_THRESHOLD为false，故useAltHashing 为false
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">boolean</span> useAltHashing <span style="color:#ff79c6">=</span> sun<span style="color:#ff79c6">.</span><span style="color:#50fa7b">misc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">VM</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isBooted</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#ff79c6">(</span>capacity <span style="color:#ff79c6">&gt;=</span> Holder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ALTERNATIVE_HASHING_THRESHOLD</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#6272a4">// false ^ false 为false        
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">boolean</span> switching <span style="color:#ff79c6">=</span> currentAltHashing <span style="color:#ff79c6">^</span> useAltHashing<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#6272a4">// 所以一般情况下，不会走到这里。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>switching<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        hashSeed <span style="color:#ff79c6">=</span> useAltHashing
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            <span style="color:#ff79c6">?</span> sun<span style="color:#ff79c6">.</span><span style="color:#50fa7b">misc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Hashing</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">randomHashSeed</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            <span style="color:#ff79c6">:</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#ff79c6">return</span> switching<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>综上，我们已经把<strong>inflateTable</strong>方法分析清楚了，其实就是把Entry数组初始化。其中Entry数组的初始化大小即为大于等于number的最小的2的n次幂。</li>
</ul>
<h3 id="2-put方法">2. put方法</h3>
<p>put方法是hashMap的最重要的方法，所以我们会重点分析，篇幅会比较长。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">public</span> V <span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">// 首次自然是空，所以要走初始化方法，而这个方法我们上文讲过，不再赘述。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>table <span style="color:#ff79c6">==</span> EMPTY_TABLE<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#6272a4">// 注意在这一步，阈值为容量 * 负载因子
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>        inflateTable<span style="color:#ff79c6">(</span>threshold<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#6272a4">// 查看2.1 putForNullKey(value)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> putForNullKey<span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#6272a4">// 查看2.3 Hash方法   
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> hash<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#6272a4">// 查看2.2 indexFor(hash, table.length)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> indexFor<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#6272a4">// 找到key对应的位置后，就要遍历这个位置对应的链表
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span> e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span> e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        Object k<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#6272a4">// hash值相等，且key相等的话，就会用新值去覆盖旧值，同时把旧值返回。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">((</span>k <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            V oldValue <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#6272a4">// 空方法，在LinkedHashMap中有实现。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">recordAccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#ff79c6">return</span> oldValue<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>    <span style="color:#6272a4">// 数据加一，作用后续会讲。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span style="color:#6272a4"></span>    modCount<span style="color:#ff79c6">++;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    <span style="color:#6272a4">// 查看2.4 addEntry(hash, key, value, i)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span style="color:#6272a4"></span>    addEntry<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    <span style="color:#6272a4">// 这里有一个小细节，如果put一个新的键值对，put方法会返回null。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="21--putfornullkeyvalue">2.1  putForNullKey(value)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4">* 这个方法主要是处理key为null的特殊情况。由此我们也可知道，HashMap是可以存储key为null的情况的
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#8be9fd;font-style:italic">private</span> V <span style="color:#50fa7b">putForNullKey</span><span style="color:#ff79c6">(</span>V value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#6272a4">// 只遍历数组第一位的链表。由此我们可知hashMap中key为null的键值对只会在数组第一位保存。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">];</span> e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span> e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>            V oldValue <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#6272a4">// 这个方法是一个空方法，在LinkedHashMap里有实现。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">recordAccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#ff79c6">return</span> oldValue<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#6272a4">// 数据加一，作用后续会讲。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#6272a4"></span>    modCount<span style="color:#ff79c6">++;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#6272a4">// 这个方法是put方法的重要内容，会在后边着重讲。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span style="color:#6272a4"></span>    addEntry<span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="22--indexforhash-tablelength">2.2  indexFor(hash, table.length)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">indexFor</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> h<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> length<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#6272a4">// assert Integer.bitCount(length) == 1 : &#34;length must be a non-zero power of 2&#34;;
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">return</span> h <span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">(</span>length<span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>​	这个方法其实也很好理解，因为length即为Entry数组的长度，而我们又知道length的值为2的n次幂。length 的2进制表示形式为最高位为1，其余位为0。那么由此可知，length - 1的二进制为最高位变为0(当然，最高位之前的依然为0)，之后的位数全部变为1。
​	例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>64：      0000 0000 0000 0000 0000 0000 0100 0000
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>64 - 1 ： 0000 0000 0000 0000 0000 0000 0011 1111
</code></pre></div><p>​		这样，当任意一个hash值与length - 1做与运算的时候有两个好处：</p>
<ol>
<li>
<p>得到的值一定小于length，因为原来的length最高位的1已经变为了0，与运算得到的结果对应的length的原最高位为0，这样一定会对应Entry数组中的一个位置，而不用担心数组角标越界。</p>
</li>
<li>
<p>因为后边均为1，则能最大程度得保留原hash值的特征，能最大限度得减少hash碰撞（试想一下，如果length没有减1，则经过与运算后，最高位之后的值均变为0，hash碰撞的可能性将大大增加）。</p>
</li>
</ol>
<h4 id="23-hash方法">2.3 Hash方法</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">hash</span><span style="color:#ff79c6">(</span>Object k<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#8be9fd">int</span> h <span style="color:#ff79c6">=</span> hashSeed<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>0 <span style="color:#ff79c6">!=</span> h <span style="color:#ff79c6">&amp;&amp;</span> k <span style="color:#ff79c6">instanceof</span> String<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#ff79c6">return</span> sun<span style="color:#ff79c6">.</span><span style="color:#50fa7b">misc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Hashing</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">stringHash32</span><span style="color:#ff79c6">((</span>String<span style="color:#ff79c6">)</span> k<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    h <span style="color:#ff79c6">^=</span> k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#6272a4">// This function ensures that hashCodes that differ only by
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// constant multiples at each bit position have a bounded
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// number of collisions (approximately 8 at default load factor).
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"></span>    h <span style="color:#ff79c6">^=</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 20<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 12<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#ff79c6">return</span> h <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 7<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 4<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>这个方法就很明确了，就是为了hash值尽量离散。用^的目的也在于此，当两个数做异或运算时，只要任何一个数发生变化，最终的结果都会不同。而与运算和或运算都不能有这样的效果。</p>
<h4 id="24-addentryhash-key-value-i">2.4 addEntry(hash, key, value, i)</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">addEntry</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> hash<span style="color:#ff79c6">,</span> K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> bucketIndex<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#6272a4">// 这里是根据条件判断是否要扩容。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>size <span style="color:#ff79c6">&gt;=</span> threshold<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> table<span style="color:#ff79c6">[</span>bucketIndex<span style="color:#ff79c6">]))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>        <span style="color:#6272a4">// 扩容逻辑，这是重点，查看2.4.2 resize(2 * table.length)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>        resize<span style="color:#ff79c6">(</span>2 <span style="color:#ff79c6">*</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>        hash <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> hash<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> 0<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>        bucketIndex <span style="color:#ff79c6">=</span> indexFor<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#6272a4">// 创建Entry对象。查看2.4.1 createEntry(hash, key, value, bucketIndex)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>    createEntry<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> bucketIndex<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span style="color:#ff79c6">}</span>
</code></pre></div><h5 id="241-createentryhash-key-value-bucketindex">2.4.1 createEntry(hash, key, value, bucketIndex)</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">createEntry</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> hash<span style="color:#ff79c6">,</span> K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> bucketIndex<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>bucketIndex<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    table<span style="color:#ff79c6">[</span>bucketIndex<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Entry<span style="color:#ff79c6">&lt;&gt;(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#6272a4">// 由此我们知道，HashMap里的size表示所有元素的个数，而不是Entry数组的个数。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span style="color:#6272a4"></span>    size<span style="color:#ff79c6">++;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#ff79c6">}</span>
</code></pre></div><pre><code>非常简单，就是用到了头插法。把最新插入的值放在了链表的最前一位。原来的第一位作为它的next节点(所以如果原来的位置没有值的话，新节点是第一个节点，它的next节点为null)。
我们不妨再看下Entry对象的结构：
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Entry</span><span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd;font-style:italic">implements</span> Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span><span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#8be9fd;font-style:italic">final</span> K key<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    V value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#8be9fd">int</span> hash<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4">     * Creates new entry.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#6272a4">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    Entry<span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> h<span style="color:#ff79c6">,</span> K k<span style="color:#ff79c6">,</span> V v<span style="color:#ff79c6">,</span> Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> n<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        value <span style="color:#ff79c6">=</span> v<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>        next <span style="color:#ff79c6">=</span> n<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>        key <span style="color:#ff79c6">=</span> k<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        hash <span style="color:#ff79c6">=</span> h<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> K <span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#ff79c6">return</span> key<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> V <span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#ff79c6">return</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> V <span style="color:#50fa7b">setValue</span><span style="color:#ff79c6">(</span>V newValue<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        V oldValue <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>        value <span style="color:#ff79c6">=</span> newValue<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>        <span style="color:#ff79c6">return</span> oldValue<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>Object o<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!(</span>o <span style="color:#ff79c6">instanceof</span> Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span><span style="color:#ff79c6">))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>        Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span> e <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span><span style="color:#ff79c6">)</span>o<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>        Object k1 <span style="color:#ff79c6">=</span> getKey<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>        Object k2 <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>k1 <span style="color:#ff79c6">==</span> k2 <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>k1 <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> k1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>k2<span style="color:#ff79c6">)))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>            Object v1 <span style="color:#ff79c6">=</span> getValue<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>            Object v2 <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>v1 <span style="color:#ff79c6">==</span> v2 <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>v1 <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> v1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>v2<span style="color:#ff79c6">)))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span>        <span style="color:#ff79c6">return</span> Objects<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">(</span>getKey<span style="color:#ff79c6">())</span> <span style="color:#ff79c6">^</span> Objects<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">(</span>getValue<span style="color:#ff79c6">());</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> String <span style="color:#50fa7b">toString</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span>        <span style="color:#ff79c6">return</span> getKey<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;=&#34;</span> <span style="color:#ff79c6">+</span> getValue<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span>    <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span style="color:#6272a4">     * This method is invoked whenever the value in an entry is
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span style="color:#6272a4">     * overwritten by an invocation of put(k,v) for a key k that&#39;s already
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span style="color:#6272a4">     * in the HashMap.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span style="color:#6272a4">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span>    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">recordAccess</span><span style="color:#ff79c6">(</span>HashMap<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> m<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span>    <span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63</span><span style="color:#6272a4">     * This method is invoked whenever the entry is
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64</span><span style="color:#6272a4">     * removed from the table.
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65</span><span style="color:#6272a4">     */</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66</span>    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">recordRemoval</span><span style="color:#ff79c6">(</span>HashMap<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> m<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>其实很简单，就是一个链表里的一个元素。</p>
<h5 id="242-resize2--tablelength">2.4.2 resize(2 * table.length)</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#6272a4">/**
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span style="color:#6272a4"> * 扩容逻辑，首先新的容量为原来容量的2倍。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4">*/</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">resize</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> newCapacity<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    Entry<span style="color:#ff79c6">[]</span> oldTable <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#8be9fd">int</span> oldCapacity <span style="color:#ff79c6">=</span> oldTable<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#6272a4">// 容量已达最大，无法再扩容，只能在原来的基础上接着往链表上加。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>oldCapacity <span style="color:#ff79c6">==</span> MAXIMUM_CAPACITY<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        threshold <span style="color:#ff79c6">=</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MAX_VALUE</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    Entry<span style="color:#ff79c6">[]</span> newTable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Entry<span style="color:#ff79c6">[</span>newCapacity<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#6272a4">// 重点，
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 一般为false。initHashSeedAsNeeded(newCapacity)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span style="color:#6272a4"></span>    transfer<span style="color:#ff79c6">(</span>newTable<span style="color:#ff79c6">,</span> initHashSeedAsNeeded<span style="color:#ff79c6">(</span>newCapacity<span style="color:#ff79c6">));</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    table <span style="color:#ff79c6">=</span> newTable<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>    threshold <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span>Math<span style="color:#ff79c6">.</span><span style="color:#50fa7b">min</span><span style="color:#ff79c6">(</span>newCapacity <span style="color:#ff79c6">*</span> loadFactor<span style="color:#ff79c6">,</span> MAXIMUM_CAPACITY <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span style="color:#ff79c6">}</span>
</code></pre></div><h6 id="2421-transfernewtable-false">2.4.2.1 transfer(newTable, false);</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transfer</span><span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">[]</span> newTable<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> rehash<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#8be9fd">int</span> newCapacity <span style="color:#ff79c6">=</span> newTable<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#6272a4">// 这里会出现线程安全的问题，原因就在于多个线程之间的table是共享的。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">:</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        <span style="color:#ff79c6">while</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>            Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> next <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#6272a4">// 一般情况下rehash为false，所以可以忽略这两行代码。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>rehash<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span> <span style="color:#ff79c6">?</span> 0 <span style="color:#ff79c6">:</span> hash<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>            <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> indexFor<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span><span style="color:#ff79c6">,</span> newCapacity<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> newTable<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>            newTable<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>            e <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>这里关于扩容后的index值有一个细节（int i = indexFor(e.hash, newCapacity)</li>
</ul>
</li>
</ul>
<ol>
<li>我们把原来的容量记为oldCapacity，新的容量记为newCapacity。因为newCapacity = oldCapacity * 2。
2. 同一个key（其实就是同一个hash），在扩容后的map里的index的值，要么跟扩容前的map里的一样，要么是 扩容前的值 + oldCapacity。
3. 原因是：newCapacity 与oldCapacity的二进制形式相比，1所在的位置比之前提前一位。则length - 1的值，差了一个1。举例最能说明问题：</li>
</ol>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>15（oldCapacity -1 ）
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>          0000 0000 0000 0000 0000 0000 0000 1111
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>31（newCapacity - 1）
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>          0000 0000 0000 0000 0000 0000 0001 1111
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span> 为了表示方便，我们只取有实际值的。任意一个hash做与运算的时候会有几种情况：
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>hash       0 ****  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>length- 1  0 1111         1 1111
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>&amp;运算结果：  0 ****         0 ****
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>以上是相同的时候。
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>hash       1 ****  
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>length- 1  0 1111         1 1111
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>&amp;运算结果：  0 ****         1 ****   
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>以上是相差oldCapacity长度的时候。
</code></pre></div><ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>先讲下扩容过程：</li>
<li>
<ul>
<li>Entry&lt;K,V&gt; next = e.next</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="../../images/HashMap1.7/image.png" alt="image"></p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e.next = newTable[i] 我们假设扩容后的index还跟之前一样。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (2)](../../images/HashMap1.7/image (2).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>newTable[i] = e;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (3)](../../images/HashMap1.7/image (3).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e = next;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (4)](../../images/HashMap1.7/image (4).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<p>while(null != e) ;</p>
<p>Entry&lt;K,V&gt; next = e.next;</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (5)](../../images/HashMap1.7/image (5)-7829518.png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>如此循环往复，最后的结果就是：</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (6)](../../images/HashMap1.7/image (6).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><strong>这里有一个特点，就是链表会发生倒转。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>其实index不完全一样的时候也是同样的道理：</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (7)](../../images/HashMap1.7/image (7).png)</p>
<p>​</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li><strong>这里有一个线程安全的问题</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>就是当有两个线程同时进行扩容的时候，假设一种情况：</p>
</li>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>在两个线程都执行完这三行代码时</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">:</span> table<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>        <span style="color:#ff79c6">while</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span> <span style="color:#ff79c6">!=</span> e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>            Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> next <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>![image (8)](../../images/HashMap1.7/image (8).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>假设第一个线程接着顺利执行完毕，第二个线程开始接着执行：</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (9)](../../images/HashMap1.7/image (9).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>第二个线程接着执行到 e.next = newTable[i];（我们还是假设index不变）。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (10)](../../images/HashMap1.7/image (10).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>newTable[i] = e;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (11)](../../images/HashMap1.7/image (11).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e = next;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (12)](../../images/HashMap1.7/image (12).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>Entry&lt;K,V&gt; next = e.next;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (13)](../../images/HashMap1.7/image (13).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e.next = newTable[i] 这一步不变。</li>
<li>newTable[i] = e;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (14)](../../images/HashMap1.7/image (14).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e = next;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (15)](../../images/HashMap1.7/image (15).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>Entry&lt;K,V&gt; next = e.next;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (16)](../../images/HashMap1.7/image (16).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e.next = newTable[i];</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (17)](../../images/HashMap1.7/image (17).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>newTable[i] = e;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (18)](../../images/HashMap1.7/image (18).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>
<ul>
<li>e = next;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>![image (19)](../../images/HashMap1.7/image (19).png)</p>
<p>这时已经不符合这个条件了：while(null != e)，循环结束。这时候就出现了循环链表。</p>
<p>在put的时候程序运行层面还看不出明显问题，但在get的时候就会看到会一直查询。</p>
<p>至此，put方法也就结束了。</p>
<h3 id="3-private-void-putforcreatek-key-v-value">3. private void putForCreate(K key, V value)</h3>
<p>这个没什么难度，就是普通的添加Entry节点</p>
<h3 id="4-public-v-getobject-key">4. public V get(Object key</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">public</span> V <span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>        <span style="color:#ff79c6">return</span> getForNullKey<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> entry <span style="color:#ff79c6">=</span> getEntry<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> entry <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">:</span> entry<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span style="color:#8be9fd;font-style:italic">final</span> Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getEntry</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>size <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> 0 <span style="color:#ff79c6">:</span> hash<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>indexFor<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>         e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>         e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        Object k<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            <span style="color:#ff79c6">((</span>k <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">))))</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            <span style="color:#ff79c6">return</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>get方法也没有什么要说的，逻辑很清晰。</p>
<h3 id="5-public-v-removeobject-key">5. public V remove(Object key)</h3>
<p>接下来谈下remove方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">public</span> V <span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> removeEntryForKey<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>e <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">:</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#8be9fd;font-style:italic">final</span> Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">removeEntryForKey</span><span style="color:#ff79c6">(</span>Object key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>size <span style="color:#ff79c6">==</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> 0 <span style="color:#ff79c6">:</span> hash<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> indexFor<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> prev <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> prev<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>        Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> next <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>        Object k<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>            <span style="color:#ff79c6">((</span>k <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">))))</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            modCount<span style="color:#ff79c6">++;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>            size<span style="color:#ff79c6">--;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>            <span style="color:#6272a4">// 需要讲的点在这里，这里的if/else分支是因为删除的情况有两种
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 一种是删除链表的第一个元素。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 另一种是删除链表的非首个元素。
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>prev <span style="color:#ff79c6">==</span> e<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>                table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>            <span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>                prev<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">recordRemoval</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>            <span style="color:#ff79c6">return</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>        prev <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        e <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>    <span style="color:#ff79c6">return</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>
<p>Entry&lt;K,V&gt; prev = table[i];</p>
<p>Entry&lt;K,V&gt; e = prev;</p>
</li>
</ul>
<p>![image (20)](../../images/HashMap1.7/image (20).png)</p>
<ul>
<li>
<p>while (e != null) {</p>
<p>Entry&lt;K,V&gt; next = e.next;</p>
</li>
</ul>
<p>![image (21)](../../images/HashMap1.7/image (21).png)</p>
<ul>
<li>接下来就分两种情况：
<ul>
<li>第一个节点就是：</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4">// 也就是这种情况
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>prev <span style="color:#ff79c6">==</span> e<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
</code></pre></div><p>![image (22)](../../images/HashMap1.7/image (22).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>删除动作就完成了。整个删除流程结束。</li>
</ul>
</li>
</ul>
</li>
<li>
<ul>
<li>
<p>第一个节点不是：</p>
<ul>
<li>
<ul>
<li>首先，不会进入if判断，会走下面的逻辑：</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>prev <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>e <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
</code></pre></div><p>![image (23)](../../images/HashMap1.7/image (23).png)</p>
<ul>
<li>
<ul>
<li>
<ul>
<li>接着进入下一次循环：</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> next <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>![image (24)](../../images/HashMap1.7/image (24).png)</p>
<p>假设这次找到了，进入if判断：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span style="color:#6272a4">// 这时不满足这个条件
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>prev <span style="color:#ff79c6">==</span> e<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span style="color:#ff79c6">else</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>   <span style="color:#6272a4">// 走这一步
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span style="color:#6272a4"></span>    prev<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span> <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
</code></pre></div><p>![image (25)](../../images/HashMap1.7/image (25).png)</p>
<p>删除逻辑也结束了。</p>
<h3 id="6-迭代器">6. 迭代器</h3>
<p>迭代器有一个地方有必要说一下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HashIterator</span><span style="color:#ff79c6">&lt;</span>E<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd;font-style:italic">implements</span> Iterator<span style="color:#ff79c6">&lt;</span>E<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> next<span style="color:#ff79c6">;</span>        <span style="color:#6272a4">// next entry to return
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> expectedModCount<span style="color:#ff79c6">;</span>   <span style="color:#6272a4">// For fast-fail
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> index<span style="color:#ff79c6">;</span>              <span style="color:#6272a4">// current slot
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span style="color:#6272a4"></span>    Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> current<span style="color:#ff79c6">;</span>     <span style="color:#6272a4">// current entry
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span style="color:#6272a4"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    HashIterator<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>        expectedModCount <span style="color:#ff79c6">=</span> modCount<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>size <span style="color:#ff79c6">&gt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">// advance to first entry
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span style="color:#6272a4"></span>            Entry<span style="color:#ff79c6">[]</span> t <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            <span style="color:#6272a4">// 主要就是这里有必要说一下
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>index <span style="color:#ff79c6">&lt;</span> t<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>next <span style="color:#ff79c6">=</span> t<span style="color:#ff79c6">[</span>index<span style="color:#ff79c6">++])</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>                <span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>        <span style="color:#ff79c6">return</span> next <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#8be9fd;font-style:italic">final</span> Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">nextEntry</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>modCount <span style="color:#ff79c6">!=</span> expectedModCount<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> ConcurrentModificationException<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>        Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> NoSuchElementException<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">((</span>next <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>            Entry<span style="color:#ff79c6">[]</span> t <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>            <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>index <span style="color:#ff79c6">&lt;</span> t<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">(</span>next <span style="color:#ff79c6">=</span> t<span style="color:#ff79c6">[</span>index<span style="color:#ff79c6">++])</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span>                <span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span>        <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span>        current <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span>        <span style="color:#ff79c6">return</span> e<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">remove</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>current <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IllegalStateException<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>modCount <span style="color:#ff79c6">!=</span> expectedModCount<span style="color:#ff79c6">)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> ConcurrentModificationException<span style="color:#ff79c6">();</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span>        Object k <span style="color:#ff79c6">=</span> current<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span>        current <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span>        HashMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeEntryForKey</span><span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">);</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span>        expectedModCount <span style="color:#ff79c6">=</span> modCount<span style="color:#ff79c6">;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span>    <span style="color:#ff79c6">}</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span style="color:#ff79c6">}</span>
</code></pre></div><p>其实逻辑也很简单，主要逻辑分三步：</p>
<ol>
<li>迭代器初始化的时候找到第一个有值的链表的头结点，赋值给next，并且此时index指向这个链表所在槽位的下一个槽位。</li>
<li>当调用迭代器的next方法时，返回上一步得到的节点。</li>
<li>同时跟第一步逻辑一样，找下一个有值的链表的头结点，如此循环往复，直到遍历结束。</li>
</ol>
<h3 id="参考资料">参考资料：</h3>
<p><a href="%5Bhttps://www.bilibili.com/video/BV1x741117jq?t=2998&amp;p=2%5D(https://www.bilibili.com/video/BV1x741117jq?t=2998&amp;p=2)">详解hashMap-B站-鲁班学院-周瑜</a></p>

  
  </div>
</article>


    <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  You 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
